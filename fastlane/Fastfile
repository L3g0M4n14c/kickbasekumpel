default_platform(:ios)

platform :ios do
  # Lane: iOS IPA bauen, signieren und zu Firebase App Distribution hochladen
  desc "Build iOS IPA and distribute via Firebase App Distribution"
  lane :distribute do |options|
    # App Store Connect API Key für Fastlane konfigurieren (kein interaktives Login nötig)
    api_key = app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_API_KEY_ISSUER_ID"],
      key_content: ENV["APP_STORE_CONNECT_API_KEY_CONTENT"],
      is_key_content_base64: false,
    )

    # Zertifikate und Provisioning Profiles aus dem privaten Match-Repo holen
    match(
      type: "adhoc",
      readonly: true,
      api_key: api_key,
    )

    # Manuelles Code Signing erzwingen (Xcode nicht automatisch signieren lassen)
    update_code_signing_settings(
      use_automatic_signing: false,
      path: "ios/Runner.xcodeproj",
      team_id: ENV["APPLE_TEAM_ID"],
      bundle_identifier: "de.legomaniac.kickbasekumpel",
      profile_name: "match AdHoc de.legomaniac.kickbasekumpel",
      code_sign_identity: "iPhone Distribution",
    )

    # Projekt-Version aus pubspec.yaml lesen
    pubspec = YAML.load_file("../pubspec.yaml")
    version_parts = pubspec["version"].split("+")
    version_name = version_parts[0]
    build_number = version_parts[1] || "1"

    # iOS IPA bauen
    build_app(
      workspace: "ios/Runner.xcworkspace",
      scheme: "Runner",
      configuration: "Release",
      export_method: "ad-hoc",
      output_directory: "build/ios/ipa",
      output_name: "kickbasekumpel.ipa",
      build_path: "build/ios",
      buildlog_path: "build/ios/logs",
      export_options: {
        method: "ad-hoc",
        provisioningProfiles: {
          "de.legomaniac.kickbasekumpel" => "match AdHoc de.legomaniac.kickbasekumpel"
        }
      }
    )

    # IPA zu Firebase App Distribution hochladen
    firebase_app_distribution(
      app: ENV["FIREBASE_APP_ID_IOS"],
      ipa_path: "build/ios/ipa/kickbasekumpel.ipa",
      groups: "internal-testers",
      release_notes: options[:release_notes] || "Automatisches Deploy von main branch",
      firebase_cli_token: ENV["FIREBASE_CLI_TOKEN"],
    )
  end
end
