default_platform(:ios)

platform :ios do
  # Lane: iOS IPA bauen, signieren und zu Firebase App Distribution hochladen
  desc "Build iOS IPA and distribute via Firebase App Distribution"
  lane :distribute do |options|
    # App Store Connect API Key für Fastlane konfigurieren (kein interaktives Login nötig)
    api_key = app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_API_KEY_ISSUER_ID"],
      key_content: ENV["APP_STORE_CONNECT_API_KEY_CONTENT"],
      is_key_content_base64: false,
    )

    # Zertifikate und Provisioning Profiles aus dem privaten Match-Repo holen
    match(
      type: "adhoc",
      readonly: true,
      api_key: api_key,
    )

    # Manuelles Code Signing erzwingen (Xcode nicht automatisch signieren lassen)
    update_code_signing_settings(
      use_automatic_signing: false,
      path: "ios/Runner.xcodeproj",
      team_id: ENV["APPLE_TEAM_ID"],
      bundle_identifier: "de.legomaniac.kickbasekumpel",
      profile_name: "match AdHoc de.legomaniac.kickbasekumpel",
      code_sign_identity: "iPhone Distribution",
    )

    # ExportOptions.plist dynamisch generieren (wird von flutter build ipa benötigt)
    export_plist_path = File.expand_path("../ios/ExportOptions.plist")
    File.write(export_plist_path, <<~PLIST)
      <?xml version="1.0" encoding="UTF-8"?>
      <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
      <plist version="1.0">
      <dict>
          <key>method</key>
          <string>ad-hoc</string>
          <key>teamID</key>
          <string>#{ENV["APPLE_TEAM_ID"]}</string>
          <key>provisioningProfiles</key>
          <dict>
              <key>de.legomaniac.kickbasekumpel</key>
              <string>match AdHoc de.legomaniac.kickbasekumpel</string>
          </dict>
          <key>signingStyle</key>
          <string>manual</string>
          <key>signingCertificate</key>
          <string>iPhone Distribution</string>
          <key>stripSwiftSymbols</key>
          <true/>
      </dict>
      </plist>
    PLIST

    # IPA via Flutter bauen – deutlich schneller als build_app/xcodebuild direkt,
    # da Flutter Dart-Kompilierung und nativen Build trennt.
    sh("cd .. && flutter build ipa --release --export-options-plist ios/ExportOptions.plist")

    # IPA zu Firebase App Distribution hochladen
    firebase_app_distribution(
      app: ENV["FIREBASE_APP_ID_IOS"],
      ipa_path: "../build/ios/ipa/Runner.ipa",
      groups: "internal-testers",
      release_notes: options[:release_notes] || "Automatisches Deploy von main branch",
      firebase_cli_token: ENV["FIREBASE_CLI_TOKEN"],
    )
  end
end
